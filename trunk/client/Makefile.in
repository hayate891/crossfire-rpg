VERSION = crossfire-client-@VERSION@
MKDIR = @MKDIR@
CP = @CP@
TAR = @TAR@
RM = @RM@
TARGET = @TARGET@
CFLAGS = @CFLAGS@ @CPPFLAGS@ -I.
LDFLAGS = @LDFLAGS@
CC = @CC@
LIBS = @LIBS@ @LIBXPM_LIB@ 
INSTALL = @INSTALL@
DEPEND = @DEPEND@
PERL = @PERL@
SOUND_DIR = @SOUNDDIR@
DMALLOC_LIB = @DMALLOC_LIB@

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
mandir=@mandir@/man1

HEADERS= \
	cconfig.h		\
	client.h		\
	clientbmap.h		\
	item.h			\
	item_types.h		\
        newclient.h		\
	proto.h			\
	soundsdef.h		

SOURCES = \
	client.c		\
	commands.c		\
	init.c			\
	item.c			\
	metaserver.c		\
	misc.c			\
	newsocket.c		\
	player.c		\
	sound.c

GTK_SOURCES = $(SOURCES) gx11.c
GTK_OBJS= $(GTK_SOURCES:.c=.o)

X11_SOURCES = $(SOURCES) x11.c
X11_OBJS= $(X11_SOURCES:.c=.o)
X_CFLAGS=@X_CFLAGS@
X_LIBS=@X_LIBS@

GTK_CFLAGS=@GTK_CFLAGS@
GTK_LIBS=@GTK_LIBS@
SND_LIBS=@SND_LIBS@

# proto only wants the .c files 

PROTOSOURCES= \
	client.c		\
	commands.c		\
	init.c			\
	item.c			\
	metaserver.c		\
	misc.c			\
	newsocket.c		\
	player.c		\
	sound.c			\
	x11.c

EXTRA_DIST = \
	aclocal.m4		\
	CHANGES			\
	COPYING			\
	Makefile.in		\
	README			\
	aclocal.m4		\
	client.man		\
	config.h.in		\
	configure		\
	configure.in		\
	def_keys		\
	def-keys.h		\
	item_types		\
	items.pl		\
	sounds.dist		\
	x11.c			\
	xutil.c			\
	gx11.c			\
	png.c			\
	cfsndserv.c

PIXMAPS = \
	pixmaps/all.xpm		\
	pixmaps/applied.xpm	\
	pixmaps/bg.xpm		\
	pixmaps/close.xpm	\
	pixmaps/coin.xpm	\
	pixmaps/crossfiretitle.xpm	\
	pixmaps/cursed.xpm	\
	pixmaps/damned.xpm	\
	pixmaps/hand.xpm	\
	pixmaps/hand2.xpm	\
	pixmaps/lock.xpm	\
	pixmaps/locked.xpm	\
	pixmaps/mag.xpm		\
	pixmaps/magic.xpm	\
	pixmaps/nonmag.xpm	\
	pixmaps/question.111	\
	pixmaps/question.xpm	\
	pixmaps/skull.xpm	\
	pixmaps/stipple.111	\
	pixmaps/stipple.112	\
	pixmaps/test.xpm	\
	pixmaps/unpaid.xpm	

HELP= \
	help/chelp.h		\
	help/shelp.h		\
	help/about.h

UTILS = \
	utils/config.guess	\
	utils/config.sub	\
	utils/mdk.sh		\
	utils/deftoheader.pl	\
	utils/install-sh	\
	utils/missing		\
	utils/mkinstalldirs

SND_SOURCES = cfsndserv.c misc.c
SND_OBJS= $(SND_SOURCES:.c=.o)


INCLUDES = @X_CFLAGS@

all:  @TARGET@ def-keys.h

gcfclient: $(GTK_OBJS)
	$(CC) -o gcfclient $(GTK_OBJS) $(LDFLAGS) $(LIBS) $(GTK_LIBS) $(DMALLOC_LIB)

cfclient: $(X11_OBJS)
	$(CC) -o cfclient $(X11_OBJS) $(LDFLAGS) $(LIBS) $(X_LIBS) $(DMALLOC_LIB)

# grumble grumble.  cextract can't seem to handle gx11.c
proto:
	cextract +p -P -o proto.h.bak -DCFCLIENT \
	-cpp-program="gcc -E -C" $(INCLUDES) -I. $(PROTOSOURCES)
	sed -e "s/#if __STDC__/#ifdef __STDC__/" -e "/__inline/d" < \
	proto.h.bak > proto.h
	$(RM) -f proto.h.bak
	chmod 664 proto.h

item_types.h: item_types
	$(PERL) items.pl

def-keys.h: def_keys
	utils/mdk.sh

sounds: sounds.dist Makefile
	$(PERL) -p -e s#/usr/local/lib/sounds#$(SOUND_DIR)# sounds.dist > sounds


soundsdef.h: sounds
	$(PERL) utils/deftoheader.pl sounds soundsdef.h def_sounds

.c.o:
	$(CC) $(CFLAGS) $(INCLUDES) -c $*.c

sound.o: soundsdef.h

gx11.o: gx11.c
	$(CC) $(CFLAGS) $(GTK_CFLAGS) $(INCLUDES) -c gx11.c

x11.o: x11.c
	$(CC) $(CFLAGS) $(X_CFLAGS) $(INCLUDES) -c x11.c

cfsndserv: $(SND_OBJS) soundsdef.h
	$(CC) -o cfsndserv $(SND_OBJS) $(LDFLAGS) $(SND_LIBS) $(DMALLOC_LIB)

archive:
	if [ -d /tmp/$(VERSION) ]; then $(RM) -rf /tmp/$(VERSION); fi
	$(MKDIR) /tmp/$(VERSION) /tmp/$(VERSION)/utils /tmp/$(VERSION)/help /tmp/$(VERSION)/pixmaps
	$(CP) $(HEADERS) $(SOURCES) $(EXTRA_DIST) /tmp/$(VERSION)
	$(CP) $(PIXMAPS) /tmp/$(VERSION)/pixmaps
	$(CP) $(HELP) /tmp/$(VERSION)/help
	$(CP) $(UTILS) /tmp/$(VERSION)/utils
	(cd /tmp; $(RM) $(VERSION).tgz; \
		$(TAR) cvfhz $(VERSION).tar.gz $(VERSION) )
	$(CP) /tmp/$(VERSION).tar.gz ../
	$(RM) -rf /tmp/$(VERSION) /tmp/$(VERSION).tar.gz


clean::
	$(RM) -f $(TARGET) $(GTK_OBJS) $(SND_OBJS) x11.o Makefile.bak

distclean::
	$(MAKE) clean
	$(RM) -f config.status config.log config.cache
	$(RM) -f cfsndserv cfclient gcfclient

install:
	$(INSTALL) -d ${bindir}
	$(INSTALL) -d ${mandir}
	@for i in $(TARGET); do \
		echo "Installing $$i"; \
		$(INSTALL) $$i ${bindir}; \
	done
	$(INSTALL) client.man ${mandir}/cfclient.1
	@if [ -x gcfclient ]; then \
	    	$(INSTALL) client.man ${mandir}/gcfclient.1; \
	fi

depend:
	$(DEPEND) $(DEPENDFLAGS) -- $(CFLAGS) $(INCLUDES)  -- $(PROTOSOURCES) $(SND_SOURCES) gx11.c
